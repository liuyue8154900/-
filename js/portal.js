$(function(){$.ajaxSetup({error:function(jqXHR){switch(jqXHR.status){case 500:alert("服务器系统内部错误");break;case 401:alert("未登录");break;case 403:alert("无权限执行此操作");break;case 404:alert("未找到对应的服务");break;default:alert("未知错误："+jqXHR.status)}}});var portal={baseUrl:sysConfig.ucenterUrl,user:{userCode:"",userName:"",neo4jId:null,graphicUrl:"",sessionId:"",loginPhone:""},ready:!1};portal.login=function(loginName,pw,rememberMe,CallBack){$.ajax({url:this.baseUrl+"/sys/login?t="+(new Date).getTime(),data:JSON.stringify({loginName:loginName,password:pw,rememberMe:rememberMe}),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:function(data,textStatus){data.success&&(portal.user.userCode=data.loginUser.code,portal.user.userName=data.loginUser.name,portal.user.loginPhone=data.loginUser.loginName,portal.user.graphicUrl=data.loginUser.graphicUrl,portal.user.neo4jId=data.loginUser.neo4jId,portal.user.sessionId=data.loginUser.sessionId,portal.writeCookie()),CallBack(data,textStatus)}})},portal.logout=function(CallBack){$.ajax({url:this.baseUrl+"/sys/logout?t="+(new Date).getTime(),type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(data){portal.clearCookie(),portal.user={},window.location.href="/index.html",CallBack(data)}})},portal.getValidateCode=function(mobile,grpValidCode,CallBack){$.ajax({url:this.baseUrl+"/sys/getRegDynamicValidCode?t="+(new Date).getTime(),data:JSON.stringify({mobile:mobile,grpValidCode:grpValidCode}),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.registerByMobile=function(userInfo,CallBack){$.ajax({url:this.baseUrl+"/sys/register?t="+(new Date).getTime(),data:JSON.stringify(userInfo),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.registerByEmail=function(userInfo,CallBack){$.ajax({url:this.baseUrl+"/sys/emailRegister?t="+(new Date).getTime(),data:JSON.stringify(userInfo),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.getPortals=function(userCode,CallBack){$.ajax({url:this.baseUrl+"/exgroup/getGroupsByUser?userCode="+userCode,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(data){if(data.success){$("#org").children("option").remove(),$("#org").append('<option data-ustate="false"  title="科技北斗" data-logo="images/logo.png" value = "1">科技北斗</option>');for(var groupBaseList=data.groupBaseList,i=0;groupBaseList.length>i;i++){var orgItem=groupBaseList[i];(void 0==orgItem.head||null==orgItem.head||""==orgItem.head)&&(orgItem.head="http://changedig-products.oss.aliyuncs.com/ent_header_default.png"),orgItem.name.length>11?$("#org").append('<option data-ustate="'+orgItem.admin+'" data-estate="'+orgItem.state+'" data-logo="'+orgItem.head+'" title="'+orgItem.name+'" value = "'+orgItem.id+'">'+orgItem.name.substr(0,4)+"..."+orgItem.name.substr(orgItem.name.length-4)+"</option>"):$("#org").append('<option data-ustate="'+orgItem.admin+'" data-estate="'+orgItem.state+'" data-logo="'+orgItem.head+'" title="'+orgItem.name+'" value = "'+orgItem.id+'">'+orgItem.name+"</option>")}}CallBack(data)}})},portal.getAppModules=function(orgId,CallBack){$.ajax({url:this.baseUrl+"/app/queryGroupApps?enterpriseCode="+orgId,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(data){if(console.log("ucenter::getAppModulees::"+data.success),data.success){$("#appModule").children("li").remove();for(var appList=data.appSelectList,i=0;appList.length>i;i++)7==appList[i].appId&&appList.splice(i,1);if(orgId.length>1)for(var i=0;appList.length>i;i++)81==appList[i].appId&&appList.splice(i,1);for(var i=0;appList.length>i;i++){var appItem=appList[i];appItem.selected&&(1==appItem.appId?1==orgId?appItem.url="/index.html":$.ajax({url:"/changedig/news/userChannel/selEnterpriseChannels?state=1&enterpriseCode="+orgId,type:"GET",dataType:"json",async:!1,contentType:"application/json; charset=utf-8",success:function(data){appItem.url=data.channelList.length>0?"/index.html#!/news/"+orgId+"/"+data.channelList[0].code:"/index.html#!/news/"+orgId+"/"}}):appItem.url=appItem.url.indexOf(":enterpriseCode")>0?appItem.url.replace(":enterpriseCode",orgId):appItem.url+"?enterpriseCode="+orgId,0==i?$("#appModule").append('<li><a class="cur" data-appid="'+appItem.appId+'" href="'+appItem.url+'" target="_blank">'+appItem.appName+"</a></li>"):$("#appModule").append('<li><a data-appid="'+appItem.appId+'" href="'+appItem.url+'" target="_blank">'+appItem.appName+"</a></li>"),"true"==$("#org").find("option:selected").attr("data-ustate")?($("#appModuleAdd a").attr("href","/enterprise.html#/appModuleManager/"+orgId),$("#appModuleAdd").css("display","")):$("#appModuleAdd").css("display","none"))}var currentOrgId=window.location.href.getUrlParam("orgId");currentOrgId&&$("#org").val(currentOrgId),$(".nlogo img").attr("src",$("#org").find("option:selected").attr("data-logo"));var ustate=$("#org").find("option:selected").attr("data-ustate");"true"==ustate?$(".houtai").show():$(".houtai").hide(),console.log("ucenter::getAppModulees::trigger::1"),$.event.trigger({type:"HeaderCompleteEvent",message:{orgId:$("#org").val()}}),CallBack(data)}}})},portal.loginHref=function(){var flag=!1;return portal.isActive(function(data){flag=data.success,flag||(portal.clearCookie(),portal.showLogin())}),flag},portal.setAppModules=function(orgId,appId,trigger,callBack){0==$("#org option[value='"+orgId+"']").length&&(orgId="1"),console.log("orgId="+orgId+",appId="+appId),$.ajax({url:this.baseUrl+"/app/queryGroupApps?enterpriseCode="+orgId,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(data){if(console.log("ucenter::getAppModulees::"+data.success),data.success){$("#appModule").children("li").remove();for(var appList=data.appSelectList,i=0;appList.length>i;i++)7==appList[i].appId&&appList.splice(i,1);if(orgId.length>1)for(var i=0;appList.length>i;i++)81==appList[i].appId&&appList.splice(i,1);for(var i=0;appList.length>i;i++){var appItem=appList[i];appItem.selected&&(1==appItem.appId?1==orgId?appItem.url="/index.html":$.ajax({url:"/changedig/news/userChannel/selEnterpriseChannels?state=1&enterpriseCode="+orgId,type:"GET",dataType:"json",async:!1,contentType:"application/json; charset=utf-8",success:function(data){appItem.url=data.channelList.length>0?"/index.html#!/news/"+orgId+"/"+data.channelList[0].code:"/index.html#!/news/"+orgId+"/"}}):appItem.url=appItem.url.indexOf(":enterpriseCode")>0?appItem.url.replace(":enterpriseCode",orgId):appItem.url+"?enterpriseCode="+orgId,appItem.appId==appId?$("#appModule").append('<li><a class="cur" data-appid="'+appItem.appId+'" href="'+appItem.url+'" target="_blank">'+appItem.appName+"</a></li>"):$("#appModule").append('<li><a data-appid="'+appItem.appId+'" href="'+appItem.url+'" target="_blank">'+appItem.appName+"</a></li>"))}$("#org").val(orgId),$(".nlogo img").attr("src",$("#org").find("option:selected").attr("data-logo"));var ustate=$("#org").find("option:selected").attr("data-ustate");"true"==ustate?($("#appModuleAdd a").attr("href","/enterprise.html#/appModuleManager/"+orgId),$("#appModuleAdd").show(),$(".houtai").show()):($("#appModuleAdd").hide(),$(".houtai").hide()),callBack(),trigger&&$.event.trigger({type:"HeaderCompleteEvent",message:{orgId:$("#org").val()}})}}})},portal.setCurrentAppModule=function(appId){$("#appModule li>a").removeClass("cur"),$("#appModule li>a[data-appid='"+appId+"']").addClass("cur")},portal.getCurrentUser=function(){var currentUser={};return currentUser.user=portal.user,currentUser.portal={},currentUser.portal.groupId=$("#org").find("option:selected").val(),currentUser.portal.groupName=$("#org").find("option:selected").prop("title"),currentUser.portal.head=$("#org").find("option:selected").attr("data-logo"),currentUser.portal.admin=$("#org").find("option:selected").attr("data-ustate"),currentUser.portal.certify=$("#org").find("option:selected").attr("data-estate"),currentUser.appModule={},currentUser.appModule.moduleId=$("#appModule li>a.cur").attr("data"),currentUser.appModule.moduleName=$("#appModule li>a.cur").text().trim(),currentUser},portal.readCookie=function(){$.cookie("user")&&(portal.user=JSON.parse($.cookie("user")))},portal.writeCookie=function(){$.cookie("web.session.id",portal.user.sessionId,{path:"/"}),$.cookie("sessionId",portal.user.sessionId,{path:"/"}),$.cookie("user",JSON.stringify(portal.user),{path:"/"})},portal.clearCookie=function(){$.cookie("web.session.id","",{expires:-1,path:"/"}),$.cookie("sessionId","",{expires:-1,path:"/"}),$.cookie("user","",{expires:-1,path:"/"})},portal.getValidateImage=function(CallBack){$.ajax({url:this.baseUrl+"/sys/getEmailValidCode?t="+(new Date).getTime(),type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.findPasswordByPhone=function(){},portal.findPasswordByEmail=function(){},portal.modifyAppModules=function(){},portal.emailActivateCheck=function(id,token,CallBack){$.ajax({url:this.baseUrl+"/sys/emailRegister?t="+(new Date).getTime(),data:JSON.stringify({id:id,token:token}),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.emailRegisterAgain=function(email,CallBack){$.ajax({url:this.baseUrl+"/sys/emailRegister?t="+(new Date).getTime(),data:JSON.stringify({email:email}),type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:CallBack})},portal.showUser=function(){portal.user.userCode?($(".user-nologin").hide(),$(".user-login.header-userinfo span span:first").html(portal.user.userName),$(".user-login").show(),$("#ulogout").show()):($(".user-login").hide(),$("#ulogout").hide(),$(".user-nologin").show())},portal.isActive=function(CallBack){$.ajax({url:this.baseUrl+"/sys/isActive?t="+(new Date).getTime(),type:"GET",dataType:"json",async:!1,contentType:"application/json; charset=utf-8",success:CallBack})},portal.showLogin=function(){$('form[name="loginForm"]')[0].reset(),$("#loginModal").show()},portal.isLogin=function(){void 0!=portal.user.userCode&&portal.user.userCode.length>0||portal.showLogin()},portal.init=function(){portal.isActive(function(data){data.success?console.log("用户依然在线"):(console.log("用户离线，清除用户信息"),portal.clearCookie()),portal.readCookie(),portal.showUser(),portal.getPortals(portal.user.userCode,function(data){if(data.success){console.log("ucenter::init::getPortals"),portal.getAppModules($("#org").find("option:selected").val(),function(){portal.ready=!0});var eCode=location.href.getUrlParam("enterpriseCode");eCode&&$("#org").val(eCode);var query=decodeURI(location.href.getUrlParam("query"));"null"!=query&&$("#searchInput").val(query)}}),$("#header_sc").bind("click",portal.loginHref)})},portal.init(),window.portal=portal});